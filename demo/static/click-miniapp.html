<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>安全验证</title>
    <style>
html, body { width:100%; height: 100%; margin: 0; padding:0; }
body { text-align: center; font-family: "PingFangSC-Regular", "Open Sans", Arial, "Hiragino Sans GB", "Microsoft YaHei", "STHeiti", "WenQuanYi Micro Hei", SimSun, sans-serif; background: linear-gradient(180deg,#66E4A7 0,#11BFCA 100%)}
.inp { border: 1px solid #cccccc; border-radius: 2px; padding: 0 10px; width: 278px; height: 40px; font-size: 18px; }
.btn { display: inline-block; box-sizing: border-box; border: 1px solid #cccccc; border-radius: 2px; width: 100px; height: 40px; line-height: 40px; font-size: 16px; color: #666; cursor: pointer; background: white linear-gradient(180deg, #ffffff 0%, #f3f3f3 100%); }
.btn:hover { background: white linear-gradient(0deg, #ffffff 0%, #f3f3f3 100%) }
#captcha { width: 300px; margin: auto; padding-top: 40%; }
label { vertical-align: top; display: inline-block; width: 80px; text-align: right; }
#wait { text-align: center; color: #666; margin: 0; width: 300px; height: 44px; border: 1px solid #ccc;box-sizing: border-box;padding-top:10px;background-image: linear-gradient(180deg, #ffffff 0%,#f3f3f3 100%)}
    </style>
</head>
<body>

<div id="captcha">
    <p id="wait" class="show">正在加载验证码......</p>
</div>    

<!-- 引入 gt.js，既可以使用其中提供的 initGeetest 初始化函数 -->
<script src="libs/gt.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
<script>
    (function(){
        var ajax = function(obj){
            var xhr = new XMLHttpRequest();            
            xhr.onreadystatechange = function(){
                if(xhr.readyState === 4){
                    if(xhr.status === 200){
                        obj.success && obj.success(JSON.parse(xhr.responseText))
                    }else{
                        obj.error && obj.error()
                    }
                }
            }
            var data = obj.data || null;
            xhr.open(obj.type||'get', obj.url);
            if(obj.type && obj.type.toLowerCase() === 'post'){
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');    
                if(obj.data){
                    var t_data = []
                    for(var p in obj.data){
                        t_data.push(p+'='+obj.data[p])
                    }
                    data = t_data.join('&')
                }
            }
            xhr.send(data)
        }
        var handler = function (captchaObj) {
            captchaObj.appendTo('#captcha');
            captchaObj.onReady(function () {
                document.getElementById('wait').style.display='none'
            }).onSuccess(function(){                
                var result = captchaObj.getValidate();
                if (!result) {
                    return alert('请完成验证');
                }
                ajax({
                    url: 'gt/validate-click',
                    type: 'POST',
                    data: {
                        geetest_challenge: result.geetest_challenge,
                        geetest_validate: result.geetest_validate,
                        geetest_seccode: result.geetest_seccode
                    },
                    success: function (data) {
                        if (data && data.status === 'success') {                            
                            if(wx && wx.miniProgram){
                                data.__type__ = 'webview_back';
                                wx.miniProgram.postMessage({data: data});                                
                                wx.miniProgram.navigateBack()
                            } else {
                                alert('没有引入微信小程序JSSDK，请查看微信小程序文档');
                            }
                        } else {
                            alert('验证失败，请重新验证');
                            captchaObj.reset();
                        }
                    }
                });
            })
        };
        ajax({
            url: "gt/register-click?t=" + (new Date()).getTime(), // 加随机数防止缓存
            type: "get",
            success: function (data) {
                initGeetest({
                    gt: data.gt,
                    challenge: data.challenge,
                    offline: !data.success,
                    new_captcha: true,
                    product: "popup",
                    width: "300px"
                }, handler);
            }
        })
    })()
</script>
</body>
</html>
